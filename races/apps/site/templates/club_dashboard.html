{% extends "site_base.html" %}
{% load bootstrap %}

{% block title %}{{club.name}}{% endblock %}

    {% block extra_head %}
    <link rel="stylesheet" href="{{ STATIC_URL }}datepicker/datepicker.css" />
    <style type='text/css'>
#id_description, #id_title, #id_url {
    width: 100%;
}
th label {
    text-align: right;
}
.datepicker{z-index:1151 !important;}
    </style>
    {% endblock %}

    {% block extra_script %}
    <script src="{{ STATIC_URL }}datepicker/bootstrap-datepicker.js"></script>
    <script>
        $(document).ready(
            function() {

                // monthly disabled by default
                $("#id_repeatMonthN").addClass("disabled").attr("disabled", true);
                $("#id_repeatDay").addClass("disabled").attr("disabled", true);
                $("#id_number").addClass("disabled").attr("disabled", true);

                $("#id_repeat").change(function() {
                    if ($(this).val() == 'none') {
                        $("#id_number").addClass("disabled").attr("disabled", true);
                    } else {
                        $("#id_number").removeClass("disabled").attr("disabled", false);
                    }
                    if ($(this).val() == 'monthly') {
                        $("#id_repeatMonthN").removeClass("disabled").attr("disabled", false);
                        $("#id_repeatDay").removeClass("disabled").attr("disabled", false);
                    } else {
                        $("#id_repeatMonthN").addClass("disabled").attr("disabled", true);
                        $("#id_repeatDay").addClass("disabled").attr("disabled", true);
                    }
                });

            });

            $(function() {
                $("#submitraceform").click(function(){
                    $.ajax({
                        type: "POST",
                        url: '{% url 'club_races' club.slug %}',
                        data: $('#raceform').serialize(),
                        success: function(msg){
                            if (msg['success']) {
                               $("#raceCreateModal").modal('hide');
                               /* force a page refresh */
                               window.location = window.location;
                           } else {
                                for (field in msg) {
                                    $("#id_"+field).parent().addClass("has-error");
                                    $("#id_"+field).parent().children(".help-block").text(msg[field]);
                                }
                            }
                        }
                    });
                });
            });
    </script>
    {% endblock %}

{% block content %}

<h2>{{club.name}}</h2>

<div class='row'>

    <div class='col-md-6'>

        <div class='well'>
            <form class="form-inline" action="{% url 'riders' %}">
              <div class="form-group">
                <input type="text" class="form-control" name="name" size=50 placeholder="Rider Name">
              </div>
              <button type="submit" class="btn btn-default">Search Riders</button>
            </form>
        </div>


        <table class='table'>
            <tbody>
            <tr><th>Current Members</th><td>{{statistics.currentmembers}}</td></tr>
            <tr><th>Race Members</th><td>{{statistics.racemembers}}</td></tr>
            <tr><th>Ride Members</th><td>{{statistics.ridemembers}}</td></tr>
            <tr><th>Non-Riding Members</th><td>{{statistics.nonridingmembers}}</td></tr>
            <tr><th>Commissaires</th><td>{% for rider in statistics.commissaires %}{{rider.user.first_name}} {{rider.user.last_name}} ({{rider.commissaire}}) {% endfor %}</td></tr>

            {% regroup statistics.roles by role.name as role_list %}

            {% for role in role_list %}
            <tr><th>{{role.grouper}}</th><td>
                {% for userrole in role.list %}
                {{userrole.user.first_name}} {{userrole.user.last_name}}{% if not forloop.last %},{% endif %}
                {% endfor %}
            </td></tr>
            {% endfor %}

        </tbody>
        </table>


        {% if club.pointscore_set.all %}
        <h2>Pointscores</h3>
            <ul>
            {% for ps in club.pointscore_set.all %}
              <li><a href="{% url 'pointscore' club=club.slug pk=ps.pk %}">{{ps}}</a></li>
            {% endfor %}
            </ul>
        {% endif %}
    </div>

    <div class='col-md-6'>

        <div class='container'>

            <ul id='dashboardActions'>
                <li>
                    <a href='{{club.website}}'><span class="glyphicon glyphicon-link" aria-hidden="true"></span><br>Club Website</a>
                </li>
                <li>
                    <a href="#" data-toggle='modal' data-target="#IMGUploadModal">
                        <span class="glyphicon glyphicon-upload" aria-hidden="true"></span><br>IMG Upload</a>
                </li>
                <li>
                    <a href="#" data-toggle='modal' data-target="#raceCreateModal">
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span><br> Add Race(s)</a>
                </li>
                <li>
                    <a href="#" data-toggle='modal' data-target="#downloadMembersModal">
                        <span class="glyphicon glyphicon-download" aria-hidden="true"></span><br> Download Riders</a>
                </li>
                <li>
                    <a href="#"  >
                    <a href="{% url 'club_riders' club.slug %}">
                        <span class="glyphicon glyphicon-user" aria-hidden="true"></span><br> Members</a>
                </a>
                </li>
                <li>
                    <a href="{% url 'club' club.slug %}">
                        <span class="glyphicon glyphicon-time" aria-hidden="true"></span><br>Race Schedule</a>
                </li>
                <li>
                    <a href="{% url 'riders' %}">
                        <span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span><br>All Riders</a>
                </li>
            </ul>

        </div>


        <div class='modal fade' id='downloadMembersModal' tabindex='-2' role='dialog' aria-labelledby="downloadMembersLabel">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                  <h4 class="modal-title" id="downloadMembersLabel">Download Rider Spreadsheet</h4>
                </div>
                <div class="modal-body">

                    <form action="{% url 'club_riders_csv' slug=club.slug %}" method='GET'>
                        <label for='eventno'>Event Number: </label>
                        <input type='text' name='eventno'> (optional, for old WMCC website)

                        <div class="modal-footer">
                          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                          <input type="submit" name="submitdownloadmembers" class="btn btn-primary" value="Download Race CSV">
                        </div>
                    </form>
                </div>
              </div>
            </div>
        </div>


        <div class="modal fade" id="IMGUploadModal" tabindex="-1" role="dialog" aria-labelledby="IMGUploadLabel">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                  <h4 class="modal-title" id="IMGUploadLabel">Upload IMG Spreadsheet</h4>
                </div>
                <div class="modal-body">
                    <p>Upload member details as downloaded from the <a href="https://console.imgstg.com/" target=new>IMG STG website</a>.
                    Choose Members > All Members then use the Blank template
                    to export all Active members. Upload the resulting spreadsheet (.xls)
                    here.</p>

                    <form method='post' action="{% url 'club_riders' club.slug %}" name='imgssform' id='imgssform' enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class='well form-group'>
                            {{memberuploadform.errors}}
                            <input type='hidden' name='club' value='{{memberuploadform.club.value}}'>
                            <input type='hidden' name='fileformat' value='IMG'>
                            {{memberuploadform.memberfile|bootstrap_inline}}

                            <div class="modal-footer">
                              <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                              <input type="submit" name="submituploadimg" class="btn btn-primary" value="Upload">
                            </div>
                        </div>
                    </form>
                </div>
              </div>
           </div>
        </div>

        <div class="modal fade" id="raceCreateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                  <h4 class="modal-title" id="myModalLabel">Create Race</h4>
                </div>

                <form method='post' action="{% url 'club_races' club.slug %}" name='raceform' id='raceform'>
                    {% csrf_token %}
                    <div class='well form-group'>
                        {{racecreateform.errors}}
                        <input type='hidden' name='club' value='{{club.id}}'>
                        <table class='table-condensed'>
                            <tr><th><label for='id_pointscore'>Pointscore</label></th>
                                <td colspan=3>{{racecreateform.pointscore|bootstrap_inline}}
                                   <span id="help_pointscore" class='help-block'></span>
                                </td>
                            </tr>

                            <tr><th><label for='id_title'>Title</label></th>
                                <td colspan=3>{{racecreateform.title|bootstrap_inline}}</td>
                            </tr>

                            <tr>
                                <th><label for='id_date'>Date</label></th>
                                <td><input class="form-control" data-provide="datepicker" name='date' id='id_date'></td>

                                <th><label for='id_time'>Sign On From</label></th>
                                <td>{{racecreateform.signontime|bootstrap_inline}}</td>
                            </tr>

                            <tr>
                                <th><label for='id_starttime'>Start Time</label></th>
                                <td colspan=3>{{racecreateform.starttime|bootstrap_inline}}</td>
                            </tr>

                            <tr>
                                <th><label for='id_weekly'>Repeat</label></th>
                                <td>{{racecreateform.repeat|bootstrap_inline}}</td>
                                <td>{{racecreateform.number|bootstrap_inline}}</td>
                                <td><label for='id_number'>times</label></td>
                            </tr>

                            <tr>
                                <th><label for='id_repeat'>Repeat on the</label></th>
                                <td>{{racecreateform.repeatMonthN|bootstrap_inline}}</td>
                                <td>{{racecreateform.repeatDay|bootstrap_inline}}</td>
                                <td><label for='id_number'>of each month</label></td>
                            </tr>


                            <tr>
                                <th><label for='id_location'>Location</label></th><td>{{racecreateform.location|bootstrap_inline}}</td>
                                <th><label for='id_status'>Status</label></th><td>{{racecreateform.status|bootstrap_inline}}</td>
                            </tr>
                            <tr><th><label for='id_url'>Website</label></th><td colspan=3>{{racecreateform.website|bootstrap_inline}}</td></tr>

                            <tr><th><label for='id_description'>Description</label></th><td colspan=3>{{racecreateform.description|bootstrap_inline}}</td></tr>
                        </table>

                        <div class="modal-footer">
                          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                          <button type="button" id="submitraceform" class="btn btn-primary">Create Race(s)</button>
                        </div>
                    </div>
                </form>
              </div>
            </div>
        </div>

    </div>






{% endblock %}
